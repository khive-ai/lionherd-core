name: Validate Links

on:
  pull_request:
    branches: [main]
    paths:
      - "notebooks/**/*.ipynb"
      - "notebooks/**/*.md"
      - "docs/**/*.md"
      - "README.md"
      - ".github/workflows/validate-links.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Check for broken links in notebooks and documentation
  # =============================================================================
  check-links:
    name: Check Links
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Extract links from notebooks
        run: |
          # Convert notebooks to markdown for link checking
          mkdir -p /tmp/nb-markdown
          find notebooks -name "*.ipynb" -type f | while read nb; do
            # Extract markdown cells and links using jq
            if command -v jq &> /dev/null; then
              jq -r '.cells[] | select(.cell_type=="markdown") | .source | join("")' "$nb" > "/tmp/nb-markdown/$(basename "$nb" .ipynb).md" 2>/dev/null || true
            fi
          done

      - name: Validate links with lychee
        uses: lycheeverse/lychee-action@v2
        with:
          # Check markdown files and extracted notebook content
          args: >-
            --verbose
            --no-progress
            --exclude-path=.venv
            --exclude-path=node_modules
            --accept=200,201,202,203,204,301,302,307,308,429
            --timeout=30
            --max-redirects=5
            --max-retries=3
            --retry-wait-time=5
            --exclude 'file:///docs/.*'
            --exclude 'file:///tmp/.*'
            --exclude 'file:///lndl/.*'
            --exclude 'file:///references/.*'
            --exclude 'file:///home/runner/work/lionherd-core/lionherd-core/docs/(user_guide|api/user_guide|api/graph|api/libs/concurrency\.md|api/utils|libs|tutorials|notebooks/references)/.*'
            --exclude 'file:///home/runner/work/lionherd-core/lionherd-core/user_guide/.*'
            --exclude 'file:///home/runner/work/lionherd-core/lionherd-core/docs/api/ln/(alcall|rcall)\.md'
            --exclude 'https://github.com/khive-ai/lionherd-core/discussions'
            --exclude 'https://www\.ons\.gov\.uk/methodology/methodologicalpublications/.*'
            notebooks/**/*.md
            /tmp/nb-markdown/*.md
            docs/**/*.md
            README.md
          fail: true
          jobSummary: true

      - name: Check relative paths in notebooks
        run: |
          echo "Checking for common relative path issues in notebooks..."

          # Check for incorrect relative paths to API docs
          if grep -r "\.\.\/\.\.\/" notebooks/ --include="*.ipynb" | grep -v ".ipynb_checkpoints"; then
            echo "⚠️  Found relative paths (../../) in notebooks"
            echo "Notebooks use relative paths based on their location"
            grep -r "\.\.\/\.\.\/" notebooks/ --include="*.ipynb" | grep -v ".ipynb_checkpoints" || true
          fi

          echo "✅ Relative path sanity checks passed (lychee will catch broken links)"

      - name: Upload link check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: link-check-results
          path: |
            lychee-out.md
